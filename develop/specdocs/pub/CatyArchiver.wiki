<<ignore  -*- coding: utf-8 -*- >>

= Catyアーカイバー


== 基本概念

* **オリジンディレクトリ** -- アーカイブ対象となるファイルが置かれているディレクトリ
* **ファイルセット** -- 「オリジンディレクトリ内にあるすべてのファイルの集合」の部分集合
* **ファイル選択フィルター** -- 「オリジンディレクトリ内にあるすべてのファイルの集合」からファイルセットを選ぶ際の基準。
* **エントリー指定** -- ファイル選択フィルターにおいて、ファイルまたはディレクトリを指定するglobパターン（リテラルも含む）。
* **ディレクティブ** -- ファイル選択フィルターに記述される、アーカイバーへの指示や情報の記述

== Catyアーカイバーの動作の概要

# オリジンディレクトリが指定される。
# ファイル選択フィルターが指定される。
# オリジンディレクトリ内のすべてのファイル／ディレクトリを列挙する。
# ファイル選択フィルターに従って、ファイル／ディレクトリを選択する。
# 選択したファイル／ディレクトリをアーカイブ（当面はzip）する。
# 必要があれば、メタデータもアーカイブに入れる。

== ファイル選択フィルターの構文

実験的にJSONによる記述を使ってきたが、人が書くには向かないことが判明した。
よって、よりクラシックで簡潔な構文を採用する。

* 行単位に解釈するテキストフィルである。
* 空行は無視される。
* コメント行は、'#' で始まる行であり、この行は無視される。
* エントリー（ファイル／ディレクトリ）指定を1行に1つずつ書く。
* エントリー指定にはglobパターンが使える。
* 他にディレクティブが書ける。ディレクティブ名は '!'から始まる語である。（CatyFITと類似構文）

{{{

syntax ファイル選択フィルター ::= 行*;
syntax 行 ::= (空行 | コメント行 | エントリー指定 | ディレクティブ);

syntax 空行 = string(pattern="^\\s*$");

syntax コメント行 ::= lexical (空白, '#', anyText);
syntax 空白 ::= lexical (' ' | '\t')*;
syntax anyText ::= lexical deferred;

syntax エントリー指定 = string(remark="globパターン");

syntax ディレクティブ ::= ディレクティブ名 引数*;

syntax ディレクティブ名 = string(remark="!の後に名前");
syntax 引数 = string("ワードまたは引用符付き文字列");

}}}

== エントリー指定

エントリー指定はglobパターンであるが：

# オリジンディレクトリをルートとみなした//絶対パス形式相対パス//が使える。
  //絶対パス形式相対パス//は、 mafsパスと同じ発想である。
# もちろん、通常の相対パス形式も使える。
# '/' から始まる場合（絶対パス形式相対パス）は、先頭からの文字列マッチ。//'/'はオリジンディレクトリにマッチする。//
# '/' から始まらない場合は、末尾からの文字列マッチ。
# './' や '../' は使えない。（カレントという概念がない。これもmafsと同様。）
# 1行に1個ずつglobパターンを書く。
# インデントせずに行頭から書き始める。
# Windowsプラットフォームを考慮すると、ワイルドカードは '*' と '?' だけを使うのが望ましい。
# リソースのパターンで使われているCaty globoではない。OSのglobである。（Caty globを使う可能性もあるが。）
# ワイルドカードを含まないリテラルでもよい。
# 末尾が '/' であれば、ディレクトリと解釈される。
# ファイルであることを明示する手段はない。（ディレクティブを使う方法がある。）

例：

{{{
# これはコメント

*.gif
/foo/bar.txt
foo
zot/*.html

}}}

== ディレクティブ

# !file -- エントリーがファイルであることを明示する。
# !dir -- エントリーがディレクトリであることを明示する。末尾に'/'を付けても同じ。
# !flat -- ディレクトリを再帰的に辿らないと指定する。
# !incl パターン -- includeパターンを指定する
# !excl パターン -- excludeパターンを指定する
# !clear -- ディフォルトのinclパターンをクリアする。

=== 大域ディレクティブと局所ディレクティブ

エントリー指定が出現する前に、//インデントなし//で書かれたディレクティブを**大域ディレクティブ**と呼ぶ。
大域ディレクティブとして使えるディレクティブは、!clear, !incl, !excl の3つである。

エントリー指定の後に、//インデント付き//で書かれたディレクティブを**局所ディレクティブ**と呼ぶ。
局所ディレクティブとして使えるディレクティブは、!file, !dir, !clear, !incl, !excl の5つ（すべて）である。

ディレクティブは大域ディレクティブか局所ディレクティブでなくてはならない。
したがって：

* エントリー指定の前に、インデント付きのディレクティブは書けない。（構文エラー）
* エントリー指定の前に、インデントなしのディレクティブは書けない。（構文エラー）


=== ホワイトリスト

アーカイバーは、ホワイトリストに従ってファイルを選択する。
オリジンディレクトリのなかのファイルで、ホワイトリストにマッチしたファイルだけをアーカイブに入れる。

!clear, !excl, !incl は、unclose構文と類似の意味を持つ。

|= ホワイトリスト  |= unclose構文 |
| !clear           | --clear オプション |
| !incl            | set指定 |
| !excl            | unset指定 |

# デフォルトのホワイトリストがある。これは、filetype登録された拡張子を持つファイル名のリストである。
  例えば、*.html, *.txt などはデフォルトのホワイトリストに含まれる。
# 大域的に !clear が指定されると、ディフォルトのホワイトリスト（inclパターン）はすべての処理においてクリアされる。
# 局所的に !clear が指定されると、そのディレクトリの検索処理の間だけホワイトリスト（inclパターン）がクリアされる。
  クリアされないときは、大域的ホワイトリストがそのまま使われる。

!incl と !excl により、デフォルトのホワイトリストに対して、globパターンの追加と削除が行える。
局所的指定のときは、当該ディレクトリの検索のときだけ有効となる。
!incl と !excl が排他的でないときはエラーとなる。

例：

{{{
# これはコメント

!excl *.bin

hoge
 !dir

*.gif
 !file
/foo/bar.txt
 !file
foo
 !file

zot/*.html
 !file

/data
 !dir
 !flat
 !clear
 !incl *.csv


}}}

== 略記（ショートハンド）

# !dir の代わりに末尾に '/' を付けることができる。
# !incl の代わりに '+'（区切り記号）を使える。
# !excl の代わりに '-'（区切り記号）を使える。


例：

{{{
# これはコメント

- *.bin

hoge/

*.gif
 !file
/foo/bar.txt
 !file
foo
 !file

zot/*.html
 !file

/data/
 !flat
 !clear
 + *.csv


}}}

== コマンドとコマンドライン

Catyアーカイバーのファイル名を caty-archiver.py とする。
シェルスクリプトなどで適当なOSコマンドにして使う。
仮に caar とすると：

* caar OPTIONS output

オプション：

* --help -- ヘルプを表示して終了
* --list -- アーカイブを作らず、標準出力にファイルの絶対パス形式相対パスをの一覧を出力
* --filter=FILE -- ファイル選択フィルターのファイル名。
  指定されないと、デフォルトのホワイトリストを使い、ディレクトリを再帰的に辿る。
* --origin=ORIGIN  -- オリジンディレクトリ。指定されないとカレントディレクトリ。 
* -q, --quiet --  メッセージの抑制

アーカイブされた結果はoutputに出力される。アーカイブ内にoutput自身を入れることはない。

== メタデータ

メタデータは、アーカイブの /META-INF/ ディレクトリの下に置かれる。


== 課題

* !file, !clear だけ略記がないが、それでよいか。

