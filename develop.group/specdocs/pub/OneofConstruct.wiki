<<ignore  -*- coding: utf-8 -*- >>

= oneof構文

**この構文の必要性は低い。適当な乱数コマンドとwhenがあれば、やりたいことは出来るので。
この文書の内容は、あくまで概念的な参考、という位置付け。**

== 動機と概要

Catyのインスタントファジングでは、
ハイパーリンク・グラフの状態ノードにクライアントエミュレーション・スクリプトを置くことにより
長時間ブルートフォーステストを実行する。
クライアントエミュレーション・スクリプトは、人間の挙動を乱数によりエミュレートする。

この例に限らず、予測不能な外部事象（happenings）をエミュレートする場合は、
乱数を使った多方向分岐が必要になる。
この処理は、適切な乱数発生器とwhen分岐を使えば書くことができるが、
専用構文があれば便利かもしれない。

oneof構文は、乱数を使った多方向分岐を書きやすくするが、
シンタックスシュガーである。

== 基本構文

キーワード 'oneof' を使う以外は、when構文と同じである。

{{{
oneof {
  a => A,
  b => B
}
}}}

when構文のタグの位置にある a, b は**分岐ラベル**と呼ぶ。
'=>' の代わりに '==>' を使うと、分岐ラベルがタグとして分岐後の処理に渡される。

分岐ラベルの直後に確率分布（確率密度、頻度）を指定することができる。

== 分岐ラベル

分岐ラベルは、名前トークン（name token）か引用された文字列（quoted string）が使える。

制御構造を可視化するとき、分岐の枝を分岐ラベルで識別することができる。
'==>' で分岐ラベルをタグとして次の処理に渡すこともできる。

{{{
null | 
oneof {
  a ==> foo,
  b ==> foo
}
}}}

この例で、一番目のfooには @a null が、二番目のfooには @b null が渡る。

次はサイコロをふるコマンドである。

{{{
command dice :: void -> ("1"|"2"|"3"|"4"|"5"|"6") {
 null | 
 oneof {
  1 ==> pass,
  2 ==> pass,
  3 ==> pass,
  4 ==> pass,
  5 ==> pass,
  6 ==> pass,
 } | tag
};

}}}

== 確率分布の指定

分岐タグの直後に、丸括弧で囲んだ非負整数を付けると、その選択肢（分岐）の出現確率を指定できる。
次の例で、foo, bar, baz の出現（実行）頻度の比率は 1 : 2 : 3 となる。

{{{
oneof {
 a (1) => foo,
 b (2) => bar,
 c (3) => baz
}
}}}

比率の分母を指定する時は次のように書く。

{{{
oneof {
 a (1/6) => foo,
 b (2/6) => bar,
 c (3/6) => baz
}
}}}

どれか1つだけ分母を書けば他の分母は省略できる。また、分母を書いた場合は、比率そのものを省略できる。

{{{
oneof {
 a (1/6) => foo,
 b (2) => bar,
 c  => baz
}
}}}

このケースで b の頻度は 2/6 、cの頻度は (6 - (1 + 2))/6 である。

{{{
oneof {
 a (1/5) => foo,
 b  => bar,
 c  => baz
}
}}}

このケースで b の頻度は ((5 - 1)/2)/5 、cの頻度も ((5 - 1)/2)/5 である。

* 分母を書かないときは、すべての選択肢に頻度を書かなくてはならない。
* 分母を書けば、頻度を省略することができる。頻度が省略された選択肢の頻度は、
  指定された頻度の残りを等分した値となる。
* 異なる値の分母が指定されるとエラーである。
* 同じ値の分母は何箇所で指定してもよい。

次は、偶数が出やすいサイコロである。

{{{
command fake-dice :: void -> ("1"|"2"|"3"|"4"|"5"|"6") {
 null | 
 oneof {
  1 (1) ==> pass,
  2 (2) ==> pass,
  3 (1) ==> pass,
  4 (2) ==> pass,
  5 (1) ==> pass,
  6 (2) ==> pass,
 } | tag
};

}}}

== 略記

一様確率分布で、分岐ラベルも不要のときは、次のように略記してよい。

{{{
oneof [foo, bar, baz]
}}}

== 構文の詳細

{{{

syntax oneofBlock ::= 'oneof' '{' choice (',' choice*<',', true>)? '}' ;
syntax choice ::= branchSpec ('=>' | '==>') expr ;
syntax branchSpec ::= label frequency? ;
syntax label ::= lexical (NameToken | QString) ;
syntax frequency ::= '(' ratio ('/' total)? ')' ;
syntax ratio ::= lexical NonNegativeInteger; // 0でもよい
syntax total ::= lexical PositiveInteger;

syntax oneofArray ::= 'oneof' '[' expr (',' expr*<',', true>)? ']' ;

}}}
